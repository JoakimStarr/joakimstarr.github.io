<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°è‹¹æœå’ŒäºŒç‹—å­çš„æ‹çˆ±æ—¶é’Ÿ</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #5a3d5c;
        overflow-x: hidden;
        position: relative;
        transition: background 0.8s ease;
      }

      /* å¿ƒå½¢èƒŒæ™¯ */
      .heart-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.3;
        pointer-events: none;
      }

      .heart {
        position: absolute;
        font-size: 20px;
        color: #ff6b8b;
        animation: float 8s infinite ease-in-out;
        pointer-events: none;
        user-select: none;
      }

      /* ä¸»å®¹å™¨ */
      .container {
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(12px);
        border-radius: 24px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        padding: 35px;
        max-width: 750px;
        width: 92%;
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.6);
        animation: fadeIn 1s ease-out;
      }

      /* æ ‡é¢˜æ ·å¼ */
      .header {
        margin-bottom: 30px;
        position: relative;
      }

      .header h1 {
        font-size: 2.4rem;
        color: #ff6b8b;
        margin-bottom: 12px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 700;
      }

      .header p {
        font-size: 1.3rem;
        color: #8a6d8f;
        font-weight: 500;
      }

      /* ç¿»é¡µè®¡æ—¶å™¨æ ·å¼ */
      .flip-timer {
        display: flex;
        justify-content: center;
        margin: 35px 0;
        flex-wrap: wrap;
        gap: 20px;
      }

      .flip-unit {
        text-align: center;
      }

      .flip-container {
        position: relative;
        width: 100px;
        height: 120px;
        perspective: 800px;
        margin: 0 auto 10px;
      }

      .flip-card {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      }

      .flip-card.flipping {
        transform: rotateX(90deg);
      }

      .flip-front,
      .flip-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        font-weight: bold;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .flip-front {
        background: white;
        color: #ff6b8b;
      }

      .flip-back {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: white;
        transform: rotateX(180deg);
      }

      .flip-label {
        font-size: 1.2rem;
        color: #8a6d8f;
        font-weight: 500;
        margin-top: 8px;
        text-align: center;
        font-weight: bold;
      }

      /* çºªå¿µæ—¥éƒ¨åˆ† */
      .milestone {
        margin: 30px 0;
        padding: 20px;
        background: rgba(255, 235, 238, 0.75);
        border-radius: 18px;
        font-size: 1.2rem;
        border: 1px solid rgba(255, 182, 193, 0.3);
      }

      /* æŒ‰é’®æ ·å¼ */
      .btn-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
      }

      .btn {
        background: #ff6b8b;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 50px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 18px rgba(255, 107, 139, 0.4);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .btn:hover {
        background: #ff8fa3;
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(255, 107, 139, 0.6);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      /* å¼‚åœ°æ‹åŒºåŸŸæ ·å¼ */
      .ldr-section {
        margin-top: 30px;
        padding: 25px;
        background: rgba(255, 240, 245, 0.9);
        border-radius: 20px;
        border: 2px solid rgba(255, 182, 193, 0.5);
        animation: fadeIn 0.8s ease-out;
        display: none;
      }

      .ldr-header {
        text-align: center;
        margin-bottom: 25px;
      }

      .ldr-header h3 {
        color: #ff6b8b;
        font-size: 1.6rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .ldr-header p {
        color: #8a6d8f;
        font-size: 1rem;
      }

      .ldr-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .ldr-stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
        border: 1px solid rgba(255, 182, 193, 0.3);
      }

      .ldr-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .ldr-icon {
        font-size: 2rem;
        color: #ff6b8b;
        margin-bottom: 10px;
      }

      .ldr-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .ldr-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ff6b8b;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      }

      .ldr-controls {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
      }

      .ldr-weather {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 182, 193, 0.3);
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .weather-loading {
        color: #8a6d8f;
        font-size: 1rem;
      }

      .weather-info {
        width: 100%;
      }

      .weather-locations {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .weather-location {
        text-align: center;
        flex: 1;
        min-width: 120px;
      }

      .location-name {
        font-weight: bold;
        color: #ff6b8b;
        margin-bottom: 8px;
        font-size: 1.2rem;
      }

      .weather-detail {
        font-size: 1rem;
        color: #666;
        margin: 5px 0;
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: popIn 0.4s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content h3 {
        color: #ff6b8b;
        font-size: 1.4rem;
        margin-bottom: 20px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #5a3d5c;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e6e6e6;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s;
        font-family: inherit;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        border-color: #ff6b8b;
        outline: none;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-small {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        margin-top: 8px;
        transition: background 0.3s;
      }

      .btn-small:hover {
        background: #5a6268;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }

      .form-actions .btn {
        flex: 1;
      }

      .location-tips {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 0.9rem;
        color: #666;
      }

      .location-tips i {
        color: #ff6b8b;
        margin-right: 5px;
      }

      /* å¤©æ°”å›¾æ ‡ */
      .weather-icon {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .weather-temperature {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ff6b8b;
        margin: 5px 0;
      }

      /* åŠ¨ç”» */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }

        50% {
          transform: translateY(-25px) rotate(5deg);
        }
      }

      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.15);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .heartbeat {
        animation: heartbeat 1.5s infinite;
        display: inline-block;
        margin: 0 10px;
        color: #ff6b8b;
      }

      /* äºŒç»´ç å¼¹çª—æ ·å¼ - æ ¹æ®å›¾ç‰‡æ ·å¼ä¼˜åŒ– */
      .qrcode-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .qrcode-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 320px;
        width: 90%;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: popIn 0.4s ease-out;
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        transition: color 0.3s;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        background: #f5f5f5;
        color: #ff6b8b;
      }

      .modal-title {
        color: #ff6b8b;
        font-size: 1.4rem;
        margin-bottom: 15px;
        font-weight: bold;
      }

      .modal-message {
        color: #333;
        font-size: 1.1rem;
        line-height: 1.5;
        margin-bottom: 10px;
      }

      .modal-message .love-days {
        color: #ff6b8b;
        font-weight: bold;
      }

      .modal-heart {
        color: #ff6b8b;
        font-size: 1.2rem;
        margin: 0 5px;
      }

      .modal-continue {
        color: #666;
        font-size: 1rem;
        margin-bottom: 20px;
      }

      #qrcode {
        margin: 15px auto;
        width: 200px;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .modal-tip {
        font-size: 0.9rem;
        color: #666;
        margin: 15px 0 20px;
      }

      .download-btn {
        background: #ff6b8b;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 107, 139, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        width: auto;
        margin: 0 auto;
      }

      .download-btn:hover {
        background: #ff8fa3;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 107, 139, 0.5);
      }

      @keyframes popIn {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }

        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .container {
          padding: 25px 20px;
          border-radius: 20px;
          width: 95%;
          max-width: 650px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .header p {
          font-size: 1.1rem;
        }

        .flip-timer {
          gap: 15px;
          margin: 25px 0;
        }

        .flip-container {
          width: 80px;
          height: 100px;
        }

        .flip-front,
        .flip-back {
          font-size: 2.8rem;
        }

        .flip-label {
          font-size: 1rem;
        }

        .btn {
          padding: 12px 20px;
          font-size: 1rem;
        }

        .ldr-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .ldr-value {
          font-size: 1.5rem;
        }

        .modal-content {
          padding: 20px;
          width: 95%;
        }

        .weather-locations {
          flex-direction: column;
          align-items: center;
        }

        .weather-location {
          min-width: 100%;
        }
      }

      @media (max-width: 480px) {
        .flip-container {
          width: 70px;
          height: 85px;
        }

        .flip-front,
        .flip-back {
          font-size: 2.2rem;
        }

        .flip-unit {
          flex: 0 0 45%;
          margin-bottom: 15px;
        }

        .flip-timer {
          gap: 10px;
        }

        .flip-label {
          font-size: 0.9rem;
        }

        .btn-container {
          flex-direction: column;
          align-items: center;
        }

        .btn {
          width: 100%;
          max-width: 200px;
          justify-content: center;
        }

        .ldr-stats {
          grid-template-columns: 1fr;
        }

        .ldr-controls {
          flex-direction: column;
          align-items: center;
        }

        .ldr-controls .btn {
          width: 100%;
          max-width: 250px;
        }

        .form-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <!-- å¿ƒå½¢èƒŒæ™¯ -->
    <div class="heart-bg" id="heartBg"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-heart heartbeat"></i> å°è‹¹æœå’ŒäºŒç‹—å­
          <i class="fas fa-heart heartbeat"></i>
        </h1>
        <p>å·²ç»åœ¨ä¸€èµ·åº¦è¿‡äº†ï¼š</p>
      </div>

      <!-- ç¿»é¡µè®¡æ—¶å™¨ -->
      <div class="flip-timer">
        <div class="flip-unit">
          <div class="flip-container" id="flip-days">
            <div class="flip-card">
              <div class="flip-front">0</div>
              <div class="flip-back">0</div>
            </div>
          </div>
          <div class="flip-label">å¤©</div>
        </div>

        <div class="flip-unit">
          <div class="flip-container" id="flip-hours">
            <div class="flip-card">
              <div class="flip-front">00</div>
              <div class="flip-back">00</div>
            </div>
          </div>
          <div class="flip-label">å°æ—¶</div>
        </div>

        <div class="flip-unit">
          <div class="flip-container" id="flip-minutes">
            <div class="flip-card">
              <div class="flip-front">00</div>
              <div class="flip-back">00</div>
            </div>
          </div>
          <div class="flip-label">åˆ†é’Ÿ</div>
        </div>

        <div class="flip-unit">
          <div class="flip-container" id="flip-seconds">
            <div class="flip-card">
              <div class="flip-front">00</div>
              <div class="flip-back">00</div>
            </div>
          </div>
          <div class="flip-label">ç§’</div>
        </div>
      </div>

      <div class="milestone" id="milestone">
        <!-- çºªå¿µæ—¥ä¿¡æ¯ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>

      <!-- å¼‚åœ°æ‹åŠŸèƒ½åŒºåŸŸ -->
      <div class="ldr-section" id="ldrSection">
        <div class="ldr-header">
          <h3><i class="fas fa-heart"></i> å¼‚åœ°æ‹ä¸“åŒº</h3>
          <p>è™½ç„¶ç›¸éš”åƒé‡Œï¼Œä½†æˆ‘ä»¬çš„å¿ƒæ°¸è¿œåœ¨ä¸€èµ·</p>
        </div>

        <div class="ldr-stats">
          <div class="ldr-stat-card">
            <div class="ldr-icon"><i class="fas fa-map-marker-alt"></i></div>
            <div class="ldr-label">å½“å‰è·ç¦»</div>
            <div class="ldr-value" id="distanceValue">-- å…¬é‡Œ</div>
          </div>

          <div class="ldr-stat-card">
            <div class="ldr-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="ldr-label">ä¸‹æ¬¡è§é¢</div>
            <div class="ldr-value" id="nextMeetValue">-- å¤©</div>
          </div>

          <div class="ldr-stat-card">
            <div class="ldr-icon"><i class="fas fa-plane"></i></div>
            <div class="ldr-label">è§é¢å€’è®¡æ—¶</div>
            <div class="ldr-value" id="meetCountdown">--</div>
          </div>
        </div>

        <div class="ldr-controls">
          <button class="btn" id="setLocationBtn">
            <i class="fas fa-map-pin"></i> è®¾ç½®ä½ç½®
          </button>
          <button class="btn" id="setMeetDateBtn">
            <i class="fas fa-heart"></i> è®¾ç½®è§é¢æ—¥
          </button>
          <button class="btn" id="toggleLDRBtn">
            <i class="fas fa-times"></i> å…³é—­å¼‚åœ°æ‹
          </button>
        </div>

        <div class="ldr-weather" id="weatherInfo">
          <div class="weather-loading">å¼€å¯å¼‚åœ°æ‹åŠŸèƒ½æŸ¥çœ‹å¤©æ°”</div>
        </div>
      </div>

      <div class="btn-container">
        <button class="btn" id="themeBtn">
          <i class="fas fa-palette"></i> åˆ‡æ¢ä¸»é¢˜
        </button>
        <button class="btn" id="shareBtn">
          <i class="fas fa-share-alt"></i> åˆ†äº«ç”œèœœ
        </button>
        <button class="btn" id="playMusicBtn">
          <i class="fas fa-play"></i> æ’­æ”¾éŸ³ä¹
        </button>
        <button class="btn" id="toggleLDRSectionBtn">
          <i class="fas fa-heart"></i> å¼‚åœ°æ‹æ¨¡å¼
        </button>
      </div>
    </div>

    <!-- äºŒç»´ç å¼¹çª— -->
    <div class="qrcode-modal" id="qrcodeModal">
      <div class="qrcode-content">
        <button class="modal-close" id="modalClose">&times;</button>
        <h2 class="modal-title">åˆ†äº«æˆ‘ä»¬çš„çˆ±</h2>
        <p class="modal-message">
          å°è‹¹æœå’ŒäºŒç‹—å­å·²ç»ç›¸çˆ±<span class="love-days" id="loveDays">999</span
          >å¤©äº†<span class="modal-heart">ğŸ’–</span>
        </p>
        <p class="modal-continue">æˆ‘ä»¬çš„çˆ±è¿˜åœ¨ç»§ç»­...</p>
        <div id="qrcode"></div>
        <p class="modal-tip">æ‰«æäºŒç»´ç ï¼Œåˆ†äº«ç”œèœœ</p>
        <button class="download-btn" id="downloadBtn">
          <i class="fas fa-download"></i> ä¸‹è½½äºŒç»´ç 
        </button>
      </div>
    </div>

    <!-- ä½ç½®è®¾ç½®å¼¹çª— -->
    <div class="modal" id="locationModal">
      <div class="modal-content">
        <button class="modal-close" id="closeLocationModal">&times;</button>
        <h3><i class="fas fa-map-marked-alt"></i> è®¾ç½®ä½ç½®ä¿¡æ¯</h3>

        <div class="location-form">
          <div class="form-group">
            <label for="myLocationName">æˆ‘çš„ä½ç½®åç§°</label>
            <input
              type="text"
              id="myLocationName"
              placeholder="åŠ¡å·"
              value="åŠ¡å·"
            />
          </div>

          <div class="form-group">
            <label for="myLocation">æˆ‘çš„åæ ‡ (çº¬åº¦,ç»åº¦)</label>
            <input
              type="text"
              id="myLocation"
              placeholder="28.5595,107.9038"
              value="28.5595,107.9038"
            />
            <button class="btn-small" id="getMyLocationBtn">
              <i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®
            </button>
          </div>

          <div class="form-group">
            <label for="partnerLocationName">å¯¹æ–¹ä½ç½®åç§°</label>
            <input
              type="text"
              id="partnerLocationName"
              placeholder="ç¥¥äº‘"
              value="ç¥¥äº‘"
            />
          </div>

          <div class="form-group">
            <label for="partnerLocation">å¯¹æ–¹åæ ‡ (çº¬åº¦,ç»åº¦)</label>
            <input
              type="text"
              id="partnerLocation"
              placeholder="25.418093,100.728523"
              value="25.418093,100.728523"
            />
          </div>

          <div class="form-actions">
            <button class="btn" id="saveLocationBtn">ä¿å­˜ä½ç½®</button>
            <button class="btn btn-secondary" id="cancelLocationBtn">
              å–æ¶ˆ
            </button>
          </div>
        </div>

        <div class="location-tips">
          <p>
            <i class="fas fa-info-circle"></i>
            æç¤ºï¼šå¯ä»¥åœ¨ç™¾åº¦åœ°å›¾æˆ–é«˜å¾·åœ°å›¾ä¸­è·å–åæ ‡
          </p>
        </div>
      </div>
    </div>

    <!-- è§é¢æ—¥æœŸè®¾ç½®å¼¹çª— -->
    <div class="modal" id="meetDateModal">
      <div class="modal-content">
        <button class="modal-close" id="closeMeetDateModal">&times;</button>
        <h3><i class="fas fa-calendar-heart"></i> è®¾ç½®ä¸‹æ¬¡è§é¢æ—¥æœŸ</h3>

        <div class="date-form">
          <div class="form-group">
            <label for="meetDate">ä¸‹æ¬¡è§é¢æ—¥æœŸ</label>
            <input type="date" id="meetDate" min="2026-03-01" />
          </div>

          <div class="form-group">
            <label for="meetLocation">è§é¢åœ°ç‚¹</label>
            <input type="text" id="meetLocation" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å—ç«™" />
          </div>

          <div class="form-group">
            <label for="meetNote">å¤‡æ³¨/è®¡åˆ’</label>
            <textarea
              id="meetNote"
              rows="3"
              placeholder="å†™ä¸‹ä½ ä»¬çš„è§é¢è®¡åˆ’..."
            ></textarea>
          </div>

          <div class="form-actions">
            <button class="btn" id="saveMeetDateBtn">ä¿å­˜è§é¢è®¡åˆ’</button>
            <button class="btn btn-secondary" id="cancelMeetDateBtn">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let audio = null;
      let isPlaying = false;

      // è®¾ç½®æ‹çˆ±å¼€å§‹çš„æ—¥æœŸå’Œæ—¶é—´
      const startDate = new Date("2025-09-04T00:00:00");

      // çºªå¿µæ—¥æ•°æ®
      const milestones = [
        { days: 100, name: "ğŸ’ æ‹çˆ±100å¤©", message: "ç™¾åˆ†ç™¾çš„çˆ±ç»™ä½ ï¼" },
        { days: 200, name: "ğŸŒ¹ æ‹çˆ±200å¤©", message: "çˆ±æ„å¦‚ç«ç‘°ç»½æ”¾ï¼" },
        { days: 365, name: "ğŸ‰ æ‹çˆ±ä¸€å‘¨å¹´", message: "å‘¨å¹´å¿«ä¹ï¼" },
        { days: 520, name: "ğŸ’– æ‹çˆ±520å¤©", message: "æˆ‘çˆ±ä½ ï¼" },
        { days: 999, name: "ğŸŒŸ æ‹çˆ±999å¤©", message: "é•¿é•¿ä¹…ä¹…ï¼" },
      ];

      // ä¸»é¢˜é¢œè‰²
      const themes = [
        {
          primary: "#ff6b8b",
          secondary: "#8a6d8f",
          bg: "linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)",
          heart: "#ff6b8b",
        },
        {
          primary: "#6a8caf",
          secondary: "#4a6572",
          bg: "linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)",
          heart: "#6a8caf",
        },
        {
          primary: "#6b5b95",
          secondary: "#4b3b6d",
          bg: "linear-gradient(135deg, #d9a7c7 0%, #fffcdc 100%)",
          heart: "#6b5b95",
        },
        {
          primary: "#44a08d",
          secondary: "#2d6a6d",
          bg: "linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)",
          heart: "#44a08d",
        },
        {
          primary: "#e65c78",
          secondary: "#8a4b6e",
          bg: "linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%)",
          heart: "#e65c78",
        },
      ];

      let currentTheme = 0;
      let animationFrameId = null;
      let qrcodeInstance = null;

      // å­˜å‚¨å½“å‰æ—¶é—´å€¼
      let currentValues = {
        days: "0",
        hours: "00",
        minutes: "00",
        seconds: "00",
      };

      // ======================== é«˜å¾·å¤©æ°”APIé…ç½® ========================
      // è¯·åœ¨æ­¤å¤„å¡«å†™æ‚¨çš„é«˜å¾·API Key
      const GAODE_API_KEY = "17b313fe31787de09faa089121652e70";
      // ======================== é…ç½®ç»“æŸ ========================

      // å¤©æ°”å›¾æ ‡æ˜ å°„è¡¨
      const weatherIconMap = {
        æ™´: "â˜€ï¸",
        å¤šäº‘: "â›…",
        é˜´: "â˜ï¸",
        é˜µé›¨: "ğŸŒ¦ï¸",
        é›·é˜µé›¨: "â›ˆï¸",
        é›·é˜µé›¨å¹¶ä¼´æœ‰å†°é›¹: "â›ˆï¸",
        é›¨å¤¹é›ª: "ğŸŒ¨ï¸",
        å°é›¨: "ğŸŒ§ï¸",
        ä¸­é›¨: "ğŸŒ§ï¸",
        å¤§é›¨: "ğŸŒ§ï¸",
        æš´é›¨: "ğŸŒ§ï¸",
        å¤§æš´é›¨: "ğŸŒ§ï¸",
        ç‰¹å¤§æš´é›¨: "ğŸŒ§ï¸",
        é˜µé›ª: "ğŸŒ¨ï¸",
        å°é›ª: "ğŸŒ¨ï¸",
        ä¸­é›ª: "ğŸŒ¨ï¸",
        å¤§é›ª: "ğŸŒ¨ï¸",
        æš´é›ª: "ğŸŒ¨ï¸",
        é›¾: "ğŸŒ«ï¸",
        å†»é›¨: "ğŸŒ¨ï¸",
        æ²™å°˜æš´: "ğŸŒªï¸",
        "å°é›¨-ä¸­é›¨": "ğŸŒ§ï¸",
        "ä¸­é›¨-å¤§é›¨": "ğŸŒ§ï¸",
        "å¤§é›¨-æš´é›¨": "ğŸŒ§ï¸",
        "æš´é›¨-å¤§æš´é›¨": "ğŸŒ§ï¸",
        "å¤§æš´é›¨-ç‰¹å¤§æš´é›¨": "ğŸŒ§ï¸",
        "å°é›ª-ä¸­é›ª": "ğŸŒ¨ï¸",
        "ä¸­é›ª-å¤§é›ª": "ğŸŒ¨ï¸",
        "å¤§é›ª-æš´é›ª": "ğŸŒ¨ï¸",
        æµ®å°˜: "ğŸŒ«ï¸",
        æ‰¬æ²™: "ğŸŒªï¸",
        å¼ºæ²™å°˜æš´: "ğŸŒªï¸",
        éœ¾: "ğŸ˜·",
        æ— : "ğŸŒ¤ï¸",
      };

      // å¼‚åœ°æ‹åŠŸèƒ½æ•°æ®
      let ldrData = {
        enabled: false,
        myLocation: {
          lat: 28.5597,
          lng: 107.904,
          name: "åŠ¡å·",
          citycode: 520326,
        },
        partnerLocation: {
          lat: 25.418093,
          lng: 100.728523,
          name: "ç¥¥äº‘",
          citycode: 532923,
        },
        nextMeetDate: "2026-03-01",
        meetLocation: "é‡åº†",
        meetNote: "å¾ˆæƒ³å®å®ï¼Œæ—©ç‚¹è§é¢ï¼",
      };
      // è®¡ç®—ä¸¤ä¸ªåæ ‡ä¹‹é—´çš„è·ç¦»ï¼ˆå…¬é‡Œï¼‰
      function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLng = ((lng2 - lng1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLng / 2) *
            Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return Math.round(R * c);
      }

      // æ›´æ–°è·ç¦»æ˜¾ç¤º
      function updateDistanceDisplay() {
        if (!ldrData.enabled) return;

        const distance = calculateDistance(
          ldrData.myLocation.lat,
          ldrData.myLocation.lng,
          ldrData.partnerLocation.lat,
          ldrData.partnerLocation.lng,
        );
        document.getElementById("distanceValue").textContent =
          `${distance} å…¬é‡Œ`;
        updateWeatherInfo();
      }

      // æ›´æ–°è§é¢å€’è®¡æ—¶
      function updateMeetCountdown() {
        if (!ldrData.enabled || !ldrData.nextMeetDate) return;

        const now = new Date();
        const meetDate = new Date(ldrData.nextMeetDate);
        const diff = meetDate - now;

        if (diff <= 0) {
          document.getElementById("nextMeetValue").textContent = "ä»Šå¤©è§é¢!";
          document.getElementById("meetCountdown").innerHTML =
            '<i class="fas fa-heart"></i> å°±åœ¨ä»Šå¤©!';
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        document.getElementById("nextMeetValue").textContent = `${days} å¤©`;
        // ç”¨ç§’è¡¨æ˜¾ç¤ºå€’è®¡æ—¶
        const totalHours = days * 24 + hours;
        document.getElementById("meetCountdown").textContent =
          `${totalHours}å°æ—¶ ${minutes}åˆ† ${seconds}ç§’`;

        // å¦‚æœå°äº7å¤©ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶è¯¦æƒ…
        if (days < 7) {
          document.getElementById("meetCountdown").innerHTML = `
          <div style="font-size: 0.9rem;">${days}å¤© ${hours}å°æ—¶</div>
          <div style="font-size: 0.7rem; color: #8a6d8f;">${minutes}åˆ† ${seconds}ç§’</div>
        `;
        }
      }

      // è·å–é«˜å¾·å¤©æ°”APIæ•°æ®
      async function getGaodeWeather(citycode) {
        if (!GAODE_API_KEY || GAODE_API_KEY === "è¯·åœ¨æ­¤å¤„å¡«å†™æ‚¨çš„é«˜å¾·API Key") {
          throw new Error("è¯·å…ˆé…ç½®é«˜å¾·API Key");
        }
        try {
          const url = `https://restapi.amap.com/v3/weather/weatherInfo?city=${citycode}&key=${GAODE_API_KEY}`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.status === "1" && data.lives && data.lives.length > 0) {
            const weatherData = data.lives[0];
            return {
              temp: weatherData.temperature,
              condition: weatherData.weather,
              icon: weatherIconMap[weatherData.weather] || "ğŸŒ¤ï¸",
              humidity: weatherData.humidity,
              windpower: weatherData.windpower,
              winddirection: weatherData.winddirection,
              reporttime: weatherData.reporttime,
            };
          } else {
            throw new Error(data.info || "å¤©æ°”æ•°æ®è·å–å¤±è´¥");
          }
        } catch (error) {
          console.error("è·å–å¤©æ°”æ•°æ®å¤±è´¥:", error);
          throw error;
        }
      }

      // è·å–å¤©æ°”ä¿¡æ¯ï¼ˆé«˜å¾·APIï¼‰
      async function updateWeatherInfo() {
        const weatherElement = document.getElementById("weatherInfo");

        if (!ldrData.enabled) {
          weatherElement.innerHTML =
            '<div class="weather-loading">å¼€å¯å¼‚åœ°æ‹åŠŸèƒ½æŸ¥çœ‹å¤©æ°”</div>';
          return;
        }

        weatherElement.innerHTML =
          '<div class="weather-loading"><i class="fas fa-cloud-sun"></i> è·å–å¤©æ°”ä¿¡æ¯ä¸­...</div>';

        try {
          // åŒæ—¶è·å–ä¸¤ä¸ªåŸå¸‚çš„å¤©æ°”
          const [myWeather, partnerWeather] = await Promise.all([
            getGaodeWeather(ldrData.myLocation.citycode).catch((err) => {
              console.error("è·å–æˆ‘çš„ä½ç½®å¤©æ°”å¤±è´¥:", err);
              return getFallbackWeather(ldrData.myLocation.name);
            }),
            // ç­‰å¾…1ç§’ä»¥é¿å…APIè¯·æ±‚è¿‡å¿«
            getGaodeWeather(ldrData.partnerLocation.citycode).catch((err) => {
              console.error("è·å–å¯¹æ–¹ä½ç½®å¤©æ°”å¤±è´¥:", err);
              return getFallbackWeather(ldrData.partnerLocation.name);
            }),
          ]);
          weatherElement.innerHTML = `
          <div class="weather-info">
            <div class="weather-locations">
              <div class="weather-location">
                <div class="location-name">${ldrData.myLocation.name}</div>
                <div class="weather-icon">${myWeather.icon}</div>
                <div class="weather-temperature">${myWeather.temp}Â°C</div>
                <div class="weather-detail">${myWeather.condition}</div>
                <div class="weather-detail">æ¹¿åº¦: ${myWeather.humidity}%</div>
                <div class="weather-detail">é£åŠ›: ${myWeather.windpower}çº§</div>
              </div>
              
              <div style="display: flex; align-items: center; color: #ff6b8b; font-size: 1.5rem;">
                <i class="fas fa-heart"></i>
              </div>
              
              <div class="weather-location">
                <div class="location-name">${ldrData.partnerLocation.name}</div>
                <div class="weather-icon">${partnerWeather.icon}</div>
                <div class="weather-temperature">${partnerWeather.temp}Â°C</div>
                <div class="weather-detail">${partnerWeather.condition}</div>
                <div class="weather-detail">æ¹¿åº¦: ${partnerWeather.humidity}%</div>
                <div class="weather-detail">é£åŠ›: ${partnerWeather.windpower}çº§</div>
              </div>
            </div>
            <div style="color: #8a6d8f; font-size: 0.9rem; margin-top: 10px;">
              <i class="fas fa-info-circle"></i> è™½ç„¶å¤©æ°”ä¸åŒï¼Œä½†çˆ±æ„ç›¸é€š
            </div>
          </div>
        `;
        } catch (error) {
          console.error("å¤©æ°”ä¿¡æ¯è·å–å¤±è´¥:", error);
          weatherElement.innerHTML = `
          <div class="weather-loading">
            <i class="fas fa-exclamation-triangle"></i> å¤©æ°”ä¿¡æ¯è·å–å¤±è´¥
            <div style="font-size: 0.8rem; margin-top: 10px;">
              è¯·æ£€æŸ¥ï¼š<br>
              1. æ˜¯å¦å·²å¡«å†™é«˜å¾·API Key<br>
              2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
              3. åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®
            </div>
          </div>
        `;
        }
      }

      // å¤‡ç”¨å¤©æ°”æ•°æ®ï¼ˆå½“APIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      function getFallbackWeather(location) {
        // æ¨¡æ‹Ÿå¤©æ°”æ•°æ®ä½œä¸ºå¤‡ç”¨
        const conditions = ["æ™´", "å¤šäº‘", "é˜´", "å°é›¨", "é˜µé›¨"];
        const icons = ["â˜€ï¸", "â›…", "â˜ï¸", "ğŸŒ§ï¸", "ğŸŒ¦ï¸"];
        const index = Math.floor(Math.random() * conditions.length);

        return {
          temp: Math.floor(15 + Math.random() * 20),
          condition: conditions[index],
          icon: icons[index],
          humidity: Math.floor(40 + Math.random() * 40),
          windpower: Math.floor(1 + Math.random() * 5) + "çº§",
          winddirection: ["ä¸œé£", "å—é£", "è¥¿é£", "åŒ—é£"][
            Math.floor(Math.random() * 4)
          ],
        };
      }

      // ä¿å­˜æ•°æ®åˆ°localStorage
      function saveLDRData() {
        localStorage.setItem("ldrData", JSON.stringify(ldrData));
      }

      // ä»localStorageåŠ è½½æ•°æ®
      function loadLDRData() {
        const saved = localStorage.getItem("ldrData");
        if (saved) {
          try {
            ldrData = JSON.parse(saved);
            getCityCodeByName(ldrData.myLocation.name).then(citycode => {
              ldrData.myLocation.citycode = citycode;
            });
            getCityCodeByName(ldrData.partnerLocation.name).then(citycode => {
              ldrData.partnerLocation.citycode = citycode;
            });
            // å¦‚æœå¼‚åœ°æ‹åŠŸèƒ½å·²å¼€å¯ï¼Œæ˜¾ç¤ºå¼‚åœ°æ‹åŒºåŸŸ
            if (ldrData.enabled) {
              document.getElementById("ldrSection").style.display = "block";
              document.getElementById("toggleLDRSectionBtn").innerHTML =
                '<i class="fas fa-heart"></i> å…³é—­å¼‚åœ°æ‹';
              updateDistanceDisplay();
              updateMeetCountdown();
              // updateWeatherInfo();
            }
          } catch (e) {
            console.error("åŠ è½½å¼‚åœ°æ‹æ•°æ®å¤±è´¥:", e);
          }
        }
      } 
      // é€šè¿‡åç§°è·å–åŸå¸‚ç¼–ç 
  async function getCityCodeByName(locationName) {
    try {
      // 1. è¾“å…¥éªŒè¯
      if (!locationName || locationName.trim() === '') {
        throw new Error('åŸå¸‚åç§°ä¸èƒ½ä¸ºç©º');
      }

      if (!GAODE_API_KEY || GAODE_API_KEY === 'è¯·åœ¨æ­¤å¤„å¡«å†™æ‚¨çš„é«˜å¾·API Key') {
        throw new Error('è¯·å…ˆé…ç½®é«˜å¾·API Key');
      }

      // 2. æ„å»ºURLå¹¶è¿›è¡Œç½‘ç»œè¯·æ±‚
      const gaoDeurl = `https://restapi.amap.com/v3/config/district?key=${GAODE_API_KEY}&keywords=${encodeURIComponent(locationName)}&subdistrict=0&extensions=base`;

      const response = await fetch(gaoDeurl);

      if (!response.ok) {
        throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
      }

      const data = await response.json();

      // 3. æ£€æŸ¥APIè¿”å›çš„çŠ¶æ€ç 
      if (data.status !== '1') {
        throw new Error(`é«˜å¾·APIè¿”å›é”™è¯¯: ${data.info || 'æœªçŸ¥é”™è¯¯'}`);
      }

      // 4. æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
      if (!data.districts || data.districts.length === 0) {
        throw new Error(`æœªæ‰¾åˆ°åŸå¸‚ "${locationName}" çš„ä¿¡æ¯`);
      }

      // 5. æ£€æŸ¥adcodeæ˜¯å¦å­˜åœ¨
      if (!data.districts[0].adcode) {
        throw new Error('APIè¿”å›çš„æ•°æ®ä¸­ç¼ºå°‘adcodeå­—æ®µ');
      }

      const adcode = data.districts[0].adcode;

      // 6. éªŒè¯adcodeæ ¼å¼ï¼ˆåº”è¯¥æ˜¯æ•°å­—ï¼‰
      if (typeof adcode !== 'string' && typeof adcode !== 'number') {
        throw new Error(`æ— æ•ˆçš„adcodeæ ¼å¼: ${adcode}`);
      }

      // 7. ç¡®ä¿è¿”å›çš„æ˜¯æ•°å­—å­—ç¬¦ä¸²
      return String(adcode).replace(/\D/g, '');

    } catch (error) {
      // 8. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
      console.error(`è·å–åŸå¸‚ "${locationName}" ç¼–ç å¤±è´¥:`, error);

      // 9. æä¾›å¸¸è§åŸå¸‚çš„å¤‡ç”¨ç¼–ç 
      const defaultCityCodes = {
        'åŠ¡å·': '520326',
        'ç¥¥äº‘': '532923',
        'åŒ—äº¬': '110000',
        'ä¸Šæµ·': '310000',
        'å¹¿å·': '440100',
        'æ·±åœ³': '440300',
        'æ­å·': '330100',
        'æˆéƒ½': '510100',
        'æ­¦æ±‰': '420100',
        'å—äº¬': '320100',
        'é‡åº†': '500000'
      };

      // 10. å°è¯•ä»é»˜è®¤ç¼–ç ä¸­æŸ¥æ‰¾
      const normalizedLocationName = locationName.replace(/å¸‚|å¿|åŒº|è‡ªæ²»å·/g, '').trim();

      for (const [city, code] of Object.entries(defaultCityCodes)) {
        if (locationName.includes(city) || city.includes(locationName) ||
          normalizedLocationName.includes(city) || city.includes(normalizedLocationName)) {
          console.warn(`ä½¿ç”¨å¤‡ç”¨ç¼–ç : ${city} -> ${code}`);
          return code;
        }
      }

      // 11. å¦‚æœæ‰¾ä¸åˆ°é»˜è®¤ç¼–ç ï¼ŒæŠ›å‡ºåŸå§‹é”™è¯¯
      throw error;
    }
  }

      // è·å–å½“å‰ä½ç½®
      function getMyLocation() {
        if (!navigator.geolocation) {
          alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½");
          return;
        }

        const loadingBtn = document.getElementById("getMyLocationBtn");
        const originalText = loadingBtn.innerHTML;
        loadingBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> è·å–ä¸­...';
        loadingBtn.disabled = true;

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById("myLocation").value =
              `${lat.toFixed(4)},${lng.toFixed(4)}`;

            // å°è¯•åå‘åœ°ç†ç¼–ç è·å–ä½ç½®åç§°
            getLocationName(lat, lng).then((name) => {
              if (name) {
                document.getElementById("myLocationName").value = name;
              }
            });

            loadingBtn.innerHTML = originalText;
            loadingBtn.disabled = false;
          },
          (error) => {
            alert("è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åæ ‡");
            console.error("è·å–ä½ç½®å¤±è´¥:", error);
            loadingBtn.innerHTML = originalText;
            loadingBtn.disabled = false;
          },
        );
      }

      // è·å–ä½ç½®åç§°ï¼ˆæ¨¡æ‹Ÿï¼‰
      function getLocationName(lat, lng) {
        return new Promise((resolve) => {
          // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸæ­£çš„åå‘åœ°ç†ç¼–ç API
          // æ¨¡æ‹Ÿè¿”å›
          const cities = [
            "åŒ—äº¬",
            "ä¸Šæµ·",
            "å¹¿å·",
            "æ·±åœ³",
            "æ­å·",
            "æˆéƒ½",
            "æ­¦æ±‰",
            "å—äº¬",
            "åŠ¡å·",
            "ç¥¥äº‘",
          ];
          resolve(cities[Math.floor(Math.random() * cities.length)]);
        });
      }

      // åˆ‡æ¢å¼‚åœ°æ‹åŒºåŸŸæ˜¾ç¤º
      function toggleLDRSection() {
        const ldrSection = document.getElementById("ldrSection");
        const toggleBtn = document.getElementById("toggleLDRSectionBtn");

        if (ldrSection.style.display === "none" || !ldrSection.style.display) {
          // å¼€å¯å¼‚åœ°æ‹åŠŸèƒ½
          ldrData.enabled = true;
          ldrSection.style.display = "block";
          toggleBtn.innerHTML = '<i class="fas fa-heart"></i> å…³é—­å¼‚åœ°æ‹';

          // æ›´æ–°æ˜¾ç¤º
          updateDistanceDisplay();
          updateMeetCountdown();
          // updateWeatherInfo();

          // å¦‚æœè¿˜æ²¡æœ‰ä½ç½®æ•°æ®ï¼Œæç¤ºè®¾ç½®ä½ç½®
          if (!ldrData.myLocation.name || !ldrData.partnerLocation.name) {
            setTimeout(() => {
              alert("è¯·å…ˆè®¾ç½®ä½ ä»¬çš„ä½ç½®ä¿¡æ¯");
              document.getElementById("locationModal").style.display = "flex";
            }, 500);
          }
        } else {
          // å…³é—­å¼‚åœ°æ‹åŠŸèƒ½
          ldrData.enabled = false;
          ldrSection.style.display = "none";
          toggleBtn.innerHTML =
            '<i class="fas fa-heart"></i> å¼‚åœ°æ‹æ¨¡å¼';
        }

        saveLDRData();
      }

      // ä¿å­˜ä½ç½®ä¿¡æ¯
      function saveLocation() {
        const myLocationInput = document
          .getElementById("myLocation")
          .value.trim();
        const myLocationName = document
          .getElementById("myLocationName")
          .value.trim();
        const partnerLocationInput = document
          .getElementById("partnerLocation")
          .value.trim();
        const partnerLocationName = document
          .getElementById("partnerLocationName")
          .value.trim();

        // éªŒè¯è¾“å…¥
        if (!myLocationInput || !partnerLocationInput) {
          alert("è¯·å¡«å†™å®Œæ•´çš„ä½ç½®ä¿¡æ¯");
          return;
        }

        // è§£æåæ ‡
        const myCoords = myLocationInput
          .split(",")
          .map((coord) => parseFloat(coord.trim()));
        const partnerCoords = partnerLocationInput
          .split(",")
          .map((coord) => parseFloat(coord.trim()));

        if (
          myCoords.length !== 2 ||
          partnerCoords.length !== 2 ||
          isNaN(myCoords[0]) ||
          isNaN(myCoords[1]) ||
          isNaN(partnerCoords[0]) ||
          isNaN(partnerCoords[1])
        ) {
          alert(
            'åæ ‡æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨"çº¬åº¦,ç»åº¦"æ ¼å¼ï¼Œä¾‹å¦‚ï¼š39.9042,116.4074',
          );
          return;
        }

        // ä¿å­˜æ•°æ®
        ldrData.myLocation = {
          lat: myCoords[0],
          lng: myCoords[1],
          name: myLocationName || "æˆ‘çš„ä½ç½®",
        };

        ldrData.partnerLocation = {
          lat: partnerCoords[0],
          lng: partnerCoords[1],
          name: partnerLocationName || "å¯¹æ–¹çš„ä½ç½®",
        };

        // æ›´æ–°æ˜¾ç¤º
        updateDistanceDisplay();
        saveLDRData();

        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById("locationModal").style.display = "none";

        alert("ä½ç½®ä¿¡æ¯å·²ä¿å­˜ï¼");
      }

      // ä¿å­˜è§é¢æ—¥æœŸ
      function saveMeetDate() {
        const meetDate = document.getElementById("meetDate").value;
        const meetLocation = document
          .getElementById("meetLocation")
          .value.trim();
        const meetNote = document.getElementById("meetNote").value.trim();

        if (!meetDate) {
          alert("è¯·é€‰æ‹©è§é¢æ—¥æœŸ");
          return;
        }

        ldrData.nextMeetDate = new Date(meetDate).toISOString();
        ldrData.meetLocation = meetLocation;
        ldrData.meetNote = meetNote;

        // æ›´æ–°æ˜¾ç¤º
        updateMeetCountdown();
        saveLDRData();

        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById("meetDateModal").style.display = "none";

        alert("è§é¢è®¡åˆ’å·²ä¿å­˜ï¼");
      }

      // åˆå§‹åŒ–å¼‚åœ°æ‹åŠŸèƒ½
      function initLongDistanceRelationship() {
        // åŠ è½½ä¿å­˜çš„æ•°æ®
        loadLDRData();

        // ç»‘å®šäº‹ä»¶
        document
          .getElementById("toggleLDRSectionBtn")
          .addEventListener("click", toggleLDRSection);
        document
          .getElementById("setLocationBtn")
          .addEventListener("click", () => {
            document.getElementById("locationModal").style.display = "flex";
          });
        document
          .getElementById("setMeetDateBtn")
          .addEventListener("click", () => {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜å¤©
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const formattedDate = tomorrow.toISOString().split("T")[0];
            document.getElementById("meetDate").value = formattedDate;
            document.getElementById("meetDate").min = formattedDate;

            // åŠ è½½å·²ä¿å­˜çš„æ•°æ®
            if (ldrData.nextMeetDate) {
              document.getElementById("meetDate").value =
                ldrData.nextMeetDate.split("T")[0];
            }
            if (ldrData.meetLocation) {
              document.getElementById("meetLocation").value =
                ldrData.meetLocation;
            }
            if (ldrData.meetNote) {
              document.getElementById("meetNote").value = ldrData.meetNote;
            }

            document.getElementById("meetDateModal").style.display = "flex";
          });
        document
          .getElementById("toggleLDRBtn")
          .addEventListener("click", toggleLDRSection);

        // ä½ç½®æ¨¡æ€æ¡†äº‹ä»¶
        document
          .getElementById("getMyLocationBtn")
          .addEventListener("click", getMyLocation);
        document
          .getElementById("saveLocationBtn")
          .addEventListener("click", saveLocation);
        document
          .getElementById("cancelLocationBtn")
          .addEventListener("click", () => {
            document.getElementById("locationModal").style.display = "none";
          });
        document
          .getElementById("closeLocationModal")
          .addEventListener("click", () => {
            document.getElementById("locationModal").style.display = "none";
          });

        // è§é¢æ—¥æœŸæ¨¡æ€æ¡†äº‹ä»¶
        document
          .getElementById("saveMeetDateBtn")
          .addEventListener("click", saveMeetDate);
        document
          .getElementById("cancelMeetDateBtn")
          .addEventListener("click", () => {
            document.getElementById("meetDateModal").style.display = "none";
          });
        document
          .getElementById("closeMeetDateModal")
          .addEventListener("click", () => {
            document.getElementById("meetDateModal").style.display = "none";
          });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll(".modal").forEach((modal) => {
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.style.display = "none";
            }
          });
        });

        // æ¯ç§’æ›´æ–°è§é¢å€’è®¡æ—¶
        if (ldrData.enabled) {
          setInterval(updateMeetCountdown, 1000);
        }
      }

      // åˆå§‹åŒ–å¿ƒå½¢èƒŒæ™¯
      function initHeartBackground() {
        const heartBg = document.getElementById("heartBg");
        const heartCount = Math.min(
          40,
          Math.floor((window.innerWidth * window.innerHeight) / 15000),
        );

        heartBg.innerHTML = "";

        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement("div");
          heart.innerHTML = "â¤";
          heart.classList.add("heart");

          heart.style.left = `${Math.random() * 100}%`;
          heart.style.top = `${Math.random() * 100}%`;
          heart.style.animationDelay = `${Math.random() * 12}s`;
          heart.style.animationDuration = `${6 + Math.random() * 10}s`;
          const size = 16 + Math.random() * 12;
          heart.style.fontSize = `${size}px`;

          heartBg.appendChild(heart);
        }
      }

      // å¯åŠ¨è®¡æ—¶å™¨
      function startLoveTimer() {
        let lastTime = Date.now();

        function update() {
          const now = Date.now();
          const diff = now - lastTime;

          if (diff >= 900) {
            updateLoveTimer();
            lastTime = now;
          }

          animationFrameId = requestAnimationFrame(update);
        }

        animationFrameId = requestAnimationFrame(update);
      }

      // æ›´æ–°è®¡æ—¶å™¨
      function updateLoveTimer() {
        const now = new Date();
        const diff = now - startDate;

        // è®¡ç®—æ—¶é—´å·®
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        // æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
        const daysStr = days.toString();
        const hoursStr = hours.toString().padStart(2, "0");
        const minutesStr = minutes.toString().padStart(2, "0");
        const secondsStr = seconds.toString().padStart(2, "0");

        // æ›´æ–°ç¿»é¡µè®¡æ—¶å™¨
        flipUpdate("days", daysStr);
        flipUpdate("hours", hoursStr);
        flipUpdate("minutes", minutesStr);
        flipUpdate("seconds", secondsStr);

        // å­˜å‚¨å½“å‰å€¼
        currentValues = {
          days: daysStr,
          hours: hoursStr,
          minutes: minutesStr,
          seconds: secondsStr,
        };

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºçºªå¿µæ—¥
        checkMilestone(days);
      }

      // ç¿»é¡µæ›´æ–°å‡½æ•°
      function flipUpdate(unit, newValue) {
        const container = document.getElementById(`flip-${unit}`);
        if (!container) return;

        const card = container.querySelector(".flip-card");
        const front = container.querySelector(".flip-front");
        const back = container.querySelector(".flip-back");

        // è·å–å½“å‰å€¼
        const currentValue = front.textContent;

        // åªæœ‰å½“å€¼æ”¹å˜æ—¶æ‰è§¦å‘ç¿»é¡µåŠ¨ç”»
        if (currentValue !== newValue) {
          // å…ˆè®¾ç½®èƒŒé¢çš„å€¼
          back.textContent = newValue;

          // è§¦å‘ç¿»é¡µåŠ¨ç”»
          card.classList.add("flipping");

          // åŠ¨ç”»ç»“æŸåæ›´æ–°æ­£é¢çš„å€¼å¹¶é‡ç½®åŠ¨ç”»
          setTimeout(() => {
            front.textContent = newValue;
            card.classList.remove("flipping");
          }, 600); // ä¸CSSä¸­çš„transitionæ—¶é—´åŒ¹é…
        }
      }

      // æ£€æŸ¥çºªå¿µæ—¥
      function checkMilestone(days) {
        const milestoneElement = document.getElementById("milestone");
        let nextMilestone = null;
        let achievedMilestone = null;

        for (const milestone of milestones) {
          if (days >= milestone.days) {
            achievedMilestone = milestone;
          } else if (!nextMilestone) {
            nextMilestone = milestone;
            break;
          }
        }

        if (
          achievedMilestone &&
          (!nextMilestone || days - achievedMilestone.days < 7)
        ) {
          milestoneElement.innerHTML = `
          <i class="fas fa-crown"></i> 
          å·²åº†ç¥ <strong>${achievedMilestone.name}</strong>ï¼
          <br><small>${achievedMilestone.message}</small>
        `;
          milestoneElement.style.background = "rgba(255, 215, 0, 0.7)";
        } else if (nextMilestone) {
          const daysLeft = nextMilestone.days - days;
          milestoneElement.innerHTML = `
          <i class="fas fa-gift"></i> 
          è·ç¦» <strong>${nextMilestone.name}</strong> è¿˜æœ‰ <strong>${daysLeft}</strong> å¤©
          <br><small>${nextMilestone.message}</small>
        `;
          milestoneElement.style.background = "rgba(255, 235, 238, 0.75)";
        } else {
          const lastMilestone = milestones[milestones.length - 1];
          milestoneElement.innerHTML = `
          <i class="fas fa-infinity"></i> 
          çˆ±æ„æŒç»­å¢é•¿ä¸­...
          <br><small>å·²è¶…è¶Š ${lastMilestone.name}ï¼</small>
        `;
          milestoneElement.style.background = "rgba(200, 230, 255, 0.75)";
        }
      }

      // åˆ‡æ¢ä¸»é¢˜
      function changeTheme() {
        currentTheme = (currentTheme + 1) % themes.length;
        const theme = themes[currentTheme];

        // æ›´æ–°èƒŒæ™¯
        document.body.style.background = theme.bg;

        // æ›´æ–°æ•°å­—é¢œè‰²
        const flipNumbers = document.querySelectorAll(
          ".flip-front, .flip-back",
        );
        flipNumbers.forEach((number) => {
          number.style.color = theme.primary;
        });

        // æ›´æ–°æŒ‰é’®é¢œè‰²
        const buttons = document.querySelectorAll(
          ".btn, .download-btn, .btn-small",
        );
        buttons.forEach((button) => {
          button.style.background = theme.primary;
        });

        // æ›´æ–°å¿ƒå½¢é¢œè‰²
        const hearts = document.querySelectorAll(".heart");
        hearts.forEach((heart) => {
          heart.style.color = theme.heart;
        });

        // æ›´æ–°æ ‡é¢˜é¢œè‰²
        const headers = document.querySelectorAll(
          ".header h1, .modal-title, .ldr-header h3, .modal-content h3",
        );
        headers.forEach((header) => {
          header.style.color = theme.primary;
        });

        // æ›´æ–°ç¿»é¡µèƒŒé¢èƒŒæ™¯
        const flipBacks = document.querySelectorAll(".flip-back");
        flipBacks.forEach((flipBack) => {
          flipBack.style.background = theme.bg;
        });

        // æ›´æ–°å¼‚åœ°æ‹åŒºåŸŸé¢œè‰²
        const ldrValues = document.querySelectorAll(
          ".ldr-value, .weather-temperature, .location-name",
        );
        ldrValues.forEach((value) => {
          value.style.color = theme.primary;
        });

        const ldrIcons = document.querySelectorAll(".ldr-icon");
        ldrIcons.forEach((icon) => {
          icon.style.color = theme.primary;
        });
      }

      // åˆ†äº«åŠŸèƒ½
      function shareLove() {
        const shareUrl = window.location.href;

        // æ›´æ–°å¼¹çª—ä¸­çš„å¤©æ•°æ˜¾ç¤º
        document.getElementById("loveDays").textContent = currentValues.days;

        // æ˜¾ç¤ºäºŒç»´ç å¼¹çª—
        showQRCodeModal(shareUrl);
      }

      // æ˜¾ç¤ºäºŒç»´ç å¼¹çª—
      function showQRCodeModal(url) {
        const modal = document.getElementById("qrcodeModal");
        const qrcodeContainer = document.getElementById("qrcode");

        // æ¸…ç©ºå®¹å™¨
        qrcodeContainer.innerHTML = "";

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = "flex";

        // ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç 
        try {
          // å¦‚æœå·²æœ‰å®ä¾‹ï¼Œå…ˆé”€æ¯
          if (qrcodeInstance) {
            qrcodeContainer.innerHTML = "";
          }

          // åˆ›å»ºæ–°çš„äºŒç»´ç 
          qrcodeInstance = new QRCode(qrcodeContainer, {
            text: url,
            width: 180,
            height: 180,
            colorDark: themes[currentTheme].primary,
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
          });
        } catch (error) {
          console.error("QRCodeåº“åŠ è½½å¤±è´¥:", error);
          qrcodeContainer.innerHTML =
            '<p style="color:red; padding: 20px;">ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚</p>';
        }
      }

      // ä¸‹è½½äºŒç»´ç 
      function downloadQRCode() {
        const canvas = document.querySelector("#qrcode canvas");
        if (canvas) {
          const link = document.createElement("a");
          link.download = "æ‹çˆ±æ—¶é’ŸäºŒç»´ç .png";
          link.href = canvas.toDataURL("image/png");
          link.click();
        } else {
          alert("è¯·å…ˆç”ŸæˆäºŒç»´ç ï¼");
        }
      }

      function toggleMusic() {
        if (!audio) {
          audio = new Audio(
            "https://music.163.com/song/media/outer/url?id=1407540299.mp3",
          );
          audio.loop = true;
        }

        const btn = document.getElementById("playMusicBtn");

        if (!isPlaying) {
          audio.play().catch((err) => {
            console.error("æ’­æ”¾å¤±è´¥:", err);
          });
          btn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœéŸ³ä¹';
          isPlaying = true;
        } else {
          audio.pause();
          btn.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾éŸ³ä¹';
          isPlaying = false;
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", () => {
        initHeartBackground();
        updateLoveTimer();
        startLoveTimer();

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document
          .getElementById("themeBtn")
          .addEventListener("click", changeTheme);
        document
          .getElementById("shareBtn")
          .addEventListener("click", shareLove);
        document
          .getElementById("playMusicBtn")
          .addEventListener("click", toggleMusic);

        // äºŒç»´ç å¼¹çª—å…³é—­æŒ‰é’®
        document.getElementById("modalClose").addEventListener("click", () => {
          document.getElementById("qrcodeModal").style.display = "none";
        });

        // ä¸‹è½½äºŒç»´ç æŒ‰é’®
        document
          .getElementById("downloadBtn")
          .addEventListener("click", downloadQRCode);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document
          .getElementById("qrcodeModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "qrcodeModal") {
              document.getElementById("qrcodeModal").style.display = "none";
            }
          });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–å¿ƒå½¢èƒŒæ™¯
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            initHeartBackground();
          }, 250);
        });

        // åˆå§‹åŒ–å¼‚åœ°æ‹åŠŸèƒ½
        setTimeout(initLongDistanceRelationship, 1000);
      });

      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener("beforeunload", () => {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
      });
    </script>
  </body>
</html>
